{% extends "layout.html"%}
{% block title %}
Configs
{% endblock %}
{%block main_content%}
    <section class="configs">
        <style>
            /* @media screen and (max-width:375.9px) {
                .configs-nav{
                    justify-content: center;
                }
            } */
            #media-form{
                position: relative;
            }
            .upload-media input{
                overflow: hidden;
                width: 0;
            }
            .upload-media label{
                padding: 2px 10px;
                font-size: 14px;
            }
        </style>
        {%if tab != 'files'%}
            <div class="configs-nav scroll scroll-h">
                <ul>
                    {%if 'upload' in tab|lower%}
                        {%set _tab = tab.split('-')[1]%}
                        <li class="upload-media">
                            <form action="/{{_tab}}/upload/{{creator}}/sfw" method="post" 
                                enctype="multipart/form-data" id="media-form-sfw" 
                                data-action-next-url="/configs?tab={{_tab}}&creator={{creator}}"
                                data-action-folder="{{_tab}}"
                                data-action-url="/medias/{{_tab}}/upload/{{creator}}/sfw" data-action-category="sfw">
                                <label for="{{_tab}}-upload-sfw" class="visually-hidden">SFW</label>
                                <input type="file" id="{{_tab}}-upload-sfw" name="file" accept="{%if _tab == 'videos'%}video/mp4,video/quicktime
                                {%else%}image/* {%endif%}" multiple>
                            </form>
                        </li>
                        <li class="upload-media">
                            <form action="/{{tab}}/upload/{{creator}}/nsfw" method="post" 
                                enctype="multipart/form-data" id="media-form-nsfw" 
                                data-action-next-url="/configs?tab={{_tab}}&creator={{creator}}"
                                data-action-folder="{{_tab}}"
                                data-action-url="/medias/{{_tab}}/upload/{{creator}}/nsfw" data-action-category="nsfw">
                                <label for="{{_tab}}-upload-nsfw" class="visually-hidden">NSFW</label>
                                <input type="file" id="{{_tab}}-upload-nsfw" name="file" accept="{%if _tab == 'videos'%}video/mp4,video/quicktime
                                {%else%}image/* {%endif%}" multiple>
                            </form>
                        </li>
                    {%else%}
                        {%set _tab = tab%}
                        <li class="{%if tab=='captions'%} active {%endif%}">
                            <a href="/configs?tab=captions&creator={{creator}}">
                                Captions
                            </a>
                        </li>
                        <!-- <li class="{%if tab=='comments'%} active {%endif%}">
                            <a href="/configs?tab=comments&creator={{creator}}">
                                Comments
                            </a>
                        </li> -->
                        <!-- <li class="{%if tab=='images'%} active {%endif%}">
                            <a href="/configs?tab=images&creator={{creator}}">
                                Images
                            </a>
                        </li>
                        <li class="{%if tab=='used_images'%} active {%endif%}">
                            <a href="/configs?tab=used_images&creator={{creator}}">
                                Used images
                            </a>
                        </li>
                      
                        <li class="{%if tab=='videos'%} active {%endif%}">
                            <a href="/configs?tab=videos&creator={{creator}}">
                                Videos
                            </a>
                        </li>
                        <li class="{%if tab=='used_videos'%} active {%endif%}">
                            <a href="/configs?tab=used_videos&creator={{creator}}">
                                Used videos
                            </a>
                        </li> -->
                        {%if tab not in ['captions','comments']%}
                            <li class="upload-{{tab}}">
                                <a href="/configs?creator={{creator}}&tab=upload-{{_tab|replace('used_','')}}">
                                    Upload {{_tab|replace('used_','')}}
                                </a>
                            </li>
                        {%endif%}
                    {%endif%}
                </ul>
            </div>
        {%else%}
            <div class="configs-nav scroll scroll-h">
                <ul>
                    <li class="{%if category=='proxies'%} active {%endif%}">
                        <a href="/configs?tab=proxies">
                            Proxies
                        </a>
                    </li>
                    <li class="{%if category=='captions'%} active {%endif%}">
                        <a href="/files/captions">
                            Captions
                        </a>
                    </li>
                    <!-- <li class="{%if category=='comments'%} active {%endif%}">
                        <a href="/files/comments">
                            Comments
                        </a>
                    </li> -->
                    {%if category in ['creators','users']%}
                        <li class="active">
                            <a href="/files/{{category}}">
                                Add {{category}}
                            </a>
                        </li>
                    {%endif%}
                </ul>
            </div>
        {%endif%}
        {%if tab in ['images','videos', 'used_images', 'used_videos']%}
            <div class="table-actions">
                <ul class="select-items">
                    <li class="select all">
                        <span>select all</span> 
                        <input type="checkbox" id="check-all" onclick="selectAll(this,'{{tab}}-grid','grid')">
                    </li>
                </ul>
                <ul class="toogle-view">
                    {%if action and action == 'get-items'%}
                        {%set item = item%}
                    {%endif%}
                    <li id="display-type">
                        <i class="fas fa-filter"></i>
                        <span>filter by</span>
                        <div class="actions">
                            <a href="/configs?tab={{tab}}&creator={{creator}}&category=sfw" 
                            class="{%if category == 'sfw'%} active {%endif%} ">SFW</a>
                            <a href="/configs?tab={{tab}}&creator={{creator}}&category=nsfw" 
                            class="{%if category == 'nsfw'%} active {%endif%} ">NSFW</a>
                            <a href="/configs?tab={{tab}}&creator={{creator}}" 
                            class="">Clear</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="grid-container">
                <ul class="media-grid" id="{{tab}}-grid">
                    {%for media in medias%}
                        <li class="media-item grid-row"
                            data-item="{{media}}"
                            data-action-target="{{creator}}">
                            <div class="item-header">
                                <span class="select">
                                    <input type="checkbox" class="checkbox-row" onclick="selectSingle(this,'grid')">
                                </span>
                                <span class="tool-tip" onclick="toogleGridActions(this)">
                                    <i class="fas fa-ellipsis-v"></i>
                                </span>
                                <ul class="actions-list">
                                    <li data-action="delete"  data-action-url="/delete-items/{{tab}}" 
                                        data-action-message="Deleting item {{media}}"  data-item="{{media}}"
                                        data-action-target="{{creator}}"
                                        onclick="handleAction(this,'{{tab}}-grid','single')">
                                        <i class="fas fa-trash text-danger"></i>
                                    </li>
                                </ul>
                            </div>
                            {%if tab in ['images','used_images']%}
                                <img src="/media/{{creator}}/{{tab}}/{{media}}" alt="{{media}}">
                            {%else%}
                                <video src="/media/{{creator}}/{{tab}}/{{media}}"></video>
                            {%endif%}
                        </li>
                    {%endfor%}
                </ul>
                <div class="table-row table-bottom grid">
                    <div class="bottom-actions show">
                        <div data-action="delete" data-action-url="/delete-items/images" 
                            data-action-message="Deleting images" 
                            class="action delete bg-danger light" onclick="handleAction(this,'images-grid','multiple','grid')">
                            Delete
                        </div>
                    </div>
                    <div class="bottom-nav">
                        <div class="sum-total">
                            Page {{page}} of {{total_pages}}
                        </div>
                        <div class="more-less">
                            {%if page > 1%}
                                <a href="{{ url_for('configs', tab=tab, page=page-1, creator=creator) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                &nbsp; &nbsp;
                            {%endif%}
                            {%if page < total_pages%}
                            <a href="{{ url_for('configs', tab=tab, page=page+1, creator=creator) }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                            {%endif%}
                        </div>
                    </div>
                </div>
            </div>
        {%elif tab == 'files'%}
            <div class="configs-container">
                {%if category in ['proxies','captions','comments']%}
                    <form action="" id="configs-form" data-action="update" 
                        data-action-message="Updating file"
                        data-action-category="{{category}}",
                        data-action-url="/files/{{category}}/update">
                        {%if configs and configs|length > 0%}
                            <textarea class="scroll scroll-v" name="configs" >{%for config in configs%}{{config}}{%endfor%}</textarea>
                        {%else%}
                            <textarea class="scroll scroll-v" name="configs" placeholder="Type your {{category}} here seperated by single newline (enter key)... &#13;&#10;{{category}} are universal"></textarea>
                        {%endif%}
                        <label for="file-input" class="file-label">Import from file:</label>
                        <input type="file" id="file-input" accept=".txt, .csv">
                        <br>
                        <input type="submit" value="Update">
                    </form>
                {%else%}
                    <form action="" id="configs-form" data-action="create" 
                        data-action-message="Adding {{category}}"
                        data-action-category="{{category}}"
                        data-action-url="/creators/add"
                        data-action-next-url="/tasks">
                    
                        <textarea class="scroll scroll-v" name="configs" id="configs-textarea" 
                            placeholder="Type email:password here separated by single newline (enter key)...&#13;&#10;{{category}} are universal" required></textarea>
                        <input type="hidden" value="{{category}}" name="category">
                        <label for="file-input" class="file-label">Import from file:</label>
                        <input type="file" id="file-input" accept=".txt, .csv">
                        <br>
                        <input type="submit" value="Add {{category}}">
                    </form>
                {%endif%}
            </div>

        {%elif tab in ['upload-images','upload-videos']%}
            {%set _tab = tab.split('-')[1]%}
            <div class="configs-container">
                <h3 class="upload-medias-info">
                    Click on either {{_tab}} categories to upload the corresponding {{_tab}}
                </h3>
            </div>

        {%elif tab == 'comments'%}
            <div class="configs-container">
                <form action="" id="configs-form"
                    data-action="update" 
                    data-action-message="Comments update"
                    data-action-category="comments"
                    data-action-url="/config/comments/update/{{creator}}">
                    {%if comments and comments|length > 0%}
                        <textarea class="scroll scroll-v" name="configs" >{%for comment in comments%}{{comment}}{%endfor%}</textarea>
                    {%else%}
                        <textarea class="scroll scroll-v" name="configs" placeholder="Type your comments here seperated by double newline (enter key)..."></textarea>
                    {%endif%}
                        <label for="file-input" class="file-label">Import from file:</label>
                        <input type="file" id="file-input" accept=".txt, .csv">
                        <br>
                        <input type="submit" value="Update">
                </form>
            </div>

        {%else%}
            <div class="configs-container">
                <form action="" id="configs-form"
                    data-action="update" 
                    data-action-message="Captions update"
                    data-action-category="captions"
                    data-action-url="/config/captions/update/{{creator}}">
                    {%if captions and captions|length > 0%}
                        <textarea class="scroll scroll-v" name="configs" >{%for cap in captions%}{{cap}}{%endfor%}</textarea>
                    {%else%}
                        <textarea class="scroll scroll-v" name="configs" placeholder="Type your captions here seperated by double newline (enter key)..."></textarea>
                    {%endif%}
                        <label for="file-input" class="file-label">Import from file:</label>
                        <input type="file" id="file-input" accept=".txt, .csv">
                        <br>
                        <input type="submit" value="Update">
                </form>
            </div>
        {%endif%}
        <style>
            .configs-container {
                width: 100%;
            }

            .configs-container form{
                border-radius: 8px;
            }
    
            .configs-container form textarea {
                width: 100%;
                min-height: 250px;
                height: auto;
                box-sizing: border-box;
                border: 1px solid var(--success);
                padding: 10px;
                resize: none;
                font-size: 16px;
            }
            .upload-medias-info{
                margin: auto;
                border: 1px solid var(--success);
                text-align: center;
                padding: 20px;
            }
        </style>
        <script>
            document.getElementById('file-input').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const textarea = document.getElementsByName('configs')[0];
                        const formated_content = content.replace(/\r\n|\r|\n/g, '\n');

                        const lines = formated_content.split('\n'); // Split content by newlines
                        let formattedLines;

                        
                        if (file.name.endsWith('.csv')) {
                            // Process CSV: Skip the header
                            formattedLines = lines
                                .slice(1) // Skip the first line (header)
                                .map(line => {
                                    const parts = line.split(','); // Split by colon
                                    if (parts.length === 3) {
                                        return `${parts[1]}:${parts[2]}`; // Extract email:password
                                    }
                                    return null; // Ignore lines that don't match the pattern
                                })
                                .filter(line => line); // Remove null values
                        } else {
                            // Process other files without skipping the header
                            formattedLines = lines.map(line => line.trim()).filter(line => line); // Keep non-empty lines
                        }
        
                        textarea.value = formattedLines.join('\n'); // Join with newlines
                    };
                    reader.readAsText(file);
                }
            });
        </script>
    </section>
{%endblock%}